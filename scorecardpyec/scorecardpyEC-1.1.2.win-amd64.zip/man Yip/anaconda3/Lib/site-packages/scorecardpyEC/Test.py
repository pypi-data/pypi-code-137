# -*- coding: utf-8 -*-
"""
Created on Sun Jan  9 10:29:30 2022

@author: j2sej
"""
import pickle
import pandas as pd
with open('%s/s1_1_dat.pkl'%'D:/work/贷前迭代_FPD15/obj/aly_br','rb') as f:
    sample = pickle.load(f)[['fpd15','CREATE_DATE','PROD_SUB_NO','SamplingWeight']]
    
with open('%s/s2_1_derive.pkl'%'D:/work/贷前迭代_FPD15/obj/aly_br','rb') as f:
    data = pickle.load(f)

with open('%s/s1_2_split_dat.pkl'%'D:/work/贷前迭代_FPD15/obj/aly_br','rb') as f:
    split = pickle.load(f)

# train_data = data.loc[split[0].index].sample(100,axis=1,random_state=0)
# test_data = data.loc[split[1].index,train_data.columns]
train_data = data.loc[split[0].index]
test_data = data.loc[split[1].index]

train_data = train_data.merge(sample[['fpd15','PROD_SUB_NO','SamplingWeight']],left_index=True,right_index=True)
test_data = test_data.merge(sample[['fpd15','PROD_SUB_NO','SamplingWeight']],left_index=True,right_index=True)

with open('%s/train.pkl'%'c:/tmp/data','wb') as f:
    pickle.dump(train_data,f)
    
with open('%s/test.pkl'%'c:/tmp/data','wb') as f:
    pickle.dump(test_data,f)
    
data = data.merge(sample,left_index=True,right_index=True)
data.CREATE_DATE = pd.to_datetime(data.CREATE_DATE.apply(str))
psi_data1 = data.loc[data.CREATE_DATE<'2021-06-01']
psi_data2 = data.loc[(data.CREATE_DATE>='2021-06-01') & (data.CREATE_DATE<'2021-07-01')]
psi_data3 = data.loc[data.CREATE_DATE>='2021-07-01']

for k,i in {'psi_data1':psi_data1,'psi_data2':psi_data2,'psi_data3':psi_data3}.items():
    i = i.loc[:,~i.columns.isin(['fpd15','PROD_SUB_NO','CREATE_DATE','SamplingWeight'])]
    with open('%s/%s.pkl'%('c:/tmp/psi_data',k),'wb') as f:
        pickle.dump(i,f)
    

d = {'2.自营及一类':[103001,104001,221001,511001,513001,517001,518001]
      ,'3.京东':[104001]
      ,'4.二类':[503001,514001,516001]}

path = 'C:/tmp/perf_pivot_data'
for k,v in d.items():
    tmp_train = train_data.loc[train_data.PROD_SUB_NO.isin(v)]
    with open('%s/%s/train.pkl'%(path,k),'wb') as f:
        pickle.dump(tmp_train,f)
        
    tmp_test = test_data.loc[test_data.PROD_SUB_NO.isin(v)]
    with open('%s/%s/test.pkl'%(path,k),'wb') as f:
        pickle.dump(tmp_test,f)